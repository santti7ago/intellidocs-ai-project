<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliDocs AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
    
        const API_BASE_URL = "https://intellidocs-ai-backend.onrender.com";

        const { useState, useEffect } = React;

        function App() {
            const [token, setToken] = useState(localStorage.getItem('authToken'));
            const [view, setView] = useState('login');

            const handleLogin = (newToken) => {
                localStorage.setItem('authToken', newToken);
                setToken(newToken);
            };

            const handleLogout = () => {
                localStorage.removeItem('authToken');
                setToken(null);
                setView('login');
            };

            if (token) {
                return <Dashboard token={token} onLogout={handleLogout} />;
            }

            return view === 'login' ? (
                <LoginPage onLogin={handleLogin} onSwitchToRegister={() => setView('register')} />
            ) : (
                <RegisterPage onSwitchToLogin={() => setView('login')} />
            );
        }

        function LoginPage({ onLogin, onSwitchToRegister }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const formData = new URLSearchParams();
                    formData.append('username', email);
                    formData.append('password', password);

                    const response = await fetch(`${API_BASE_URL}/api/v1/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error('Email o contraseña incorrectos.');
                    }

                    const data = await response.json();
                    onLogin(data.access_token);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Inicia sesión</h2>
                        <form onSubmit={handleSubmit}>
                            {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">Email</label>
                                <input type="email" id="email" value={email} onChange={e => setEmail(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">Contraseña</label>
                                <input type="password" id="password" value={password} onChange={e => setPassword(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required />
                            </div>
                            <div className="flex items-center justify-between">
                                <button type="submit" disabled={loading} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full disabled:bg-indigo-300">
                                    {loading ? 'Entrando...' : 'Entrar'}
                                </button>
                            </div>
                        </form>
                        <p className="text-center text-gray-600 text-sm mt-6">
                            ¿No tienes cuenta? <button onClick={onSwitchToRegister} className="text-indigo-600 hover:text-indigo-800 font-bold">Regístrate</button>
                        </p>
                    </div>
                </div>
            );
        }

        function RegisterPage({ onSwitchToLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password }),
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.detail || 'Error al registrar.');
                    }
                    
                    setSuccess('¡Cuenta creada exitosamente! Ahora puedes iniciar sesión.');
                    setTimeout(() => onSwitchToLogin(), 2000);

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                 <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Crea tu cuenta</h2>
                        <form onSubmit={handleSubmit}>
                            {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}
                            {success && <p className="text-green-500 text-sm text-center mb-4">{success}</p>}
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">Email</label>
                                <input type="email" id="email" value={email} onChange={e => setEmail(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">Contraseña</label>
                                <input type="password" id="password" value={password} onChange={e => setPassword(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required />
                            </div>
                            <div className="flex items-center justify-between">
                                <button type="submit" disabled={loading} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full disabled:bg-indigo-300">
                                    {loading ? 'Creando cuenta...' : 'Registrarse'}
                                </button>
                            </div>
                        </form>
                         <p className="text-center text-gray-600 text-sm mt-6">
                            ¿Ya tienes cuenta? <button onClick={onSwitchToLogin} className="text-indigo-600 hover:text-indigo-800 font-bold">Inicia sesión</button>
                        </p>
                    </div>
                </div>
            );
        }

        function Dashboard({ token, onLogout }) {
            const [documents, setDocuments] = useState([]);
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');

            const fetchDocuments = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/documents/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('No se pudieron cargar los documentos.');
                    const data = await response.json();
                    setDocuments(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            useEffect(() => {
                fetchDocuments();
            }, [token]);

            const handleFileChange = (e) => {
                setFile(e.target.files[0]);
            };

            const handleUpload = async (e) => {
                e.preventDefault();
                if (!file) {
                    setError('Por favor, selecciona un archivo PDF.');
                    return;
                }
                setError('');
                setLoading(true);

                const formData = new FormData();
                formData.append('file', file);
                
                try {
                     const response = await fetch(`${API_BASE_URL}/api/v1/documents/`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData,
                    });
                    if (!response.ok) {
                         const errData = await response.json();
                         throw new Error(errData.detail || 'Error al subir el archivo.');
                    }
                    await fetchDocuments(); // Refresh list
                    setFile(null);
                    e.target.reset(); // Reset form
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-gray-100 min-h-screen">
                    <nav className="bg-white shadow-md">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <h1 className="text-xl font-bold text-indigo-600">IntelliDocs AI</h1>
                                <button onClick={onLogout} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                                    Cerrar Sesión
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                        <div className="px-4 py-6 sm:px-0">
                            {/* Upload Section */}
                            <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                <h2 className="text-xl font-semibold mb-4 text-gray-800">Sube un Nuevo Documento</h2>
                                {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                                <form onSubmit={handleUpload}>
                                    <div className="mb-4">
                                        <input type="file" onChange={handleFileChange} accept=".pdf" className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                                    </div>
                                    <button type="submit" disabled={loading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded disabled:bg-indigo-300">
                                        {loading ? 'Procesando...' : 'Subir y Analizar'}
                                    </button>
                                </form>
                            </div>

                            {/* Documents List */}
                            <h2 className="text-2xl font-semibold mb-4 text-gray-800">Tus Documentos</h2>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {documents.length > 0 ? documents.map(doc => (
                                    <div key={doc.id} className="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                                        <h3 className="text-lg font-bold text-gray-900 mb-2 truncate">{doc.analysis.title}</h3>
                                        <p className="text-sm text-gray-600 mb-4 h-20 overflow-hidden">{doc.analysis.summary}</p>
                                        <div className="flex flex-wrap gap-2">
                                            {doc.analysis.keywords.map((kw, i) => (
                                                <span key={i} className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">{kw}</span>
                                            ))}
                                        </div>
                                        <p className="text-xs text-gray-400 mt-4 truncate">Archivo: {doc.filename}</p>
                                    </div>
                                )) : (
                                    <p className="text-gray-500">No tienes documentos. ¡Sube uno para empezar!</p>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

